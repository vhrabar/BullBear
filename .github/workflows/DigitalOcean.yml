name: Deploy to DigitalOcean

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DO_DROPLET_IP }} >> ~/.ssh/known_hosts

      - name: Upload project files
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/id_rsa" \
            ./ \
            root@${{ secrets.DO_DROPLET_IP }}:/root/bullbear/

      - name: Write backend .env on server
        env:
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_SSLMODE: ${{ secrets.DB_SSLMODE }}
          PRODUCTION: ${{ secrets.PRODUCTION }}
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ secrets.DO_DROPLET_IP }} << 'EOF'
          cd /root/bullbear/src/backend

cat > .env << 'EOT'
DB_NAME=${DB_NAME}
DB_USER=${DB_USER}
DB_PASSWORD=${DB_PASSWORD}
DB_HOST=${DB_HOST}
DB_PORT=${DB_PORT}
DB_SSLMODE=${DB_SSLMODE}

PRODUCTION=${PRODUCTION}
EOT

          EOF

      - name: Rebuild and restart Docker
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ secrets.DO_DROPLET_IP }} << 'EOF'
          cd /root/bullbear
          docker compose down
          docker compose build --no-cache
          docker compose up -d
          EOF
